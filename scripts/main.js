"use strict";angular.module("pubTran",["ngAnimate","ngTouch","ngRoute","cb.x2js"]),angular.module("pubTran").config(["$routeProvider","SwProvider",function(t){t.when("/",{templateUrl:"views/main.html",controller:"mainController"})}]).run(["Sw",angular.noop]),angular.module("pubTran").constant("bartKey","MW9S-E7SL-26DU-VV8V").constant("idbName","pubTran").constant("idbVersion",2).constant("routeNumbers",[1,2,3,4,5,6,7,8,11,12,19,20]),angular.module("pubTran").factory("Idb",["idbName","idbVersion",function(t,n){function r(){return navigator.serviceWorker?idb.open(t,n,function(t){switch(t.oldVersion){case 0:t.createObjectStore("stations",{keyPath:"abbr"});case 1:t.createObjectStore("trains")}}):Promise.resolve()}var e={};return e.connectionPromise=r(),e}]),angular.module("pubTran").factory("Sw",function(){function t(){return navigator.serviceWorker?navigator.serviceWorker.register("/publicTransportation/service-worker.js").then(function(t){return console.log("registered worker with scope: ",t.scope),t})["catch"](function(){console.log("failed to register worker")}):void 0}var n={};return n.worker=t(),n}),angular.module("pubTran").factory("Schedules",["$http","x2js","bartKey",function(t,n,r){var e={};return e.getSchedule=function(e,o){return t({method:"GET",url:"http://api.bart.gov/api/sched.aspx?cmd=depart&orig="+e+"&dest="+o+"&key="+r}).then(function(t){return n.xml_str2json(t.data)})},e}]),angular.module("pubTran").factory("Stations",["$http","x2js","bartKey","Idb",function(t,n,r,e){function o(){return t({method:"GET",url:"http://api.bart.gov/api/stn.aspx?cmd=stns&key="+r})}function a(){return s.then(function(t){if(t){var n=t.transaction("stations"),r=n.objectStore("stations");return r.getAll()}})}function i(t){s.then(function(n){if(n){var r=n.transaction("stations","readwrite"),e=r.objectStore("stations");t.forEach(function(t){e.put(t)})}})}var u={stationList:[]},s=e.connectionPromise;return u.getAll=function(){var t=this;return a().then(function(r){return r.length?(t.stationList=r,Promise.resolve(r)):o().then(function(t){var r=n.xml_str2json(t.data).root.stations.station;return i(r),u.stationList=r,r})})},u}]),angular.module("pubTran").factory("Trains",["$http","$q","x2js","bartKey","Idb","routeNumbers",function(t,n,r,e,o,a){function i(t){return r.xml_str2json(t)}function u(){return a.map(function(n){var r="http://api.bart.gov/api/sched.aspx?cmd=routesched&route="+n+"&key="+e;return t({method:"GET",url:r})})}function s(t){return Promise.all(t).then(function(t){console.log(t);var n=-1;return l.then(function(r){if(r){var e=r.transaction("trains","readwrite"),o=e.objectStore("trains");t.forEach(function(t){var r=i(t.data),e=r.root.uri.split("=").pop();r.root.route.train.forEach(function(t){var r={routeNumber:e,stops:t.stop};o.put(r,++n)})})}})})}function c(){return l.then(function(t){if(t){var n=t.transaction("trains"),r=n.objectStore("trains"),e=r.getAll();return e.then(function(t){f.trainsList=t}),e}})}var l=o.connectionPromise,f={trainsList:[]};return f.getAll=function(){var t=this;return c().then(function(r){if(r.length){var e=n.defer();return t.trainsList=r,e.resolve(r)}return s(u()).then(function(){return c()})})},f}]),angular.module("pubTran").controller("mainController",["$scope","$timeout","Schedules","Stations","Trains",function(t,n,r,e,o){function a(t,n,r){return t.filter(function(t){var e=0,o=0;return t.stops.forEach(function(t,a){t._station===n&&(e=a),t._station===r&&(o=a)}),e>0&&o-e>0}).map(function(t){return t.stops.filter(function(t){return t._station===n||t._station===r})})}function i(e,i){return e===i?void(t.error="Departure and arrival stations must be different"):(t.error="",void r.getSchedule(e.abbr,i.abbr).then(function(r){n(function(){t.schedules=r.root.schedule.request.trip})})["catch"](function(){t.schedules=!1,n(function(){t.localSchedules=a(o.trainsList,e.abbr,i.abbr)})}))}t.loadingForm=!0,t.getRealTimeSchedule=i,e.getAll().then(function(){n(function(){t.stations=e.stationList,t.selectedDeparture=t.stations[0],t.selectedArrival=t.stations[1],t.loadingForm=!1,i(t.selectedDeparture,t.selectedArrival)})}),o.getAll().then(function(){n(function(){t.trains=o.trainsList})})}]);
